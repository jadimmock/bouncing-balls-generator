/*!
 * A jQuery plugin to replace all matched <img> elements with its
 * bouncy balls implementation.
 *
 * Based on the Google's 'bouncy balls' doodle and Rob Hawkes' canvas
 * implementation (http://goo.gl/fbPt). For more information please
 * see the blog post (http://goo.gl/4OEC).
 *
 * Usage: $('#myImg').bouncyBalls();
 *
 * Options:
 * 		ballSize: The size of each point / ball.
 *		spacing: The amount of spacing between each point / ball.
 *		variance: The variance in ball size (0-1).
 *		friction: The amount of friction (0-1).
 *		zIndex: The z-index of the canvas onto which the balls
 *			are rendered. While it is transparent, if it is above
 *			the content you won't be able to click / select anything.
 *			The pointer position is detected on mousemove over the
 *			body, so will work irrespective of the canvas z-index.
 */
(function(e){function b(f,h,g){this.x=f;this.y=h;this.z=g;this.addX=function(i){this.x+=i};this.addY=function(i){this.y+=i};this.addZ=function(i){this.z+=i};this.set=function(i,k,j){this.x=i;this.y=k;this.z=j}}function c(f,j,i,g,h){this.colour=h;this.curPos=new b(f,j,i);this.originalPos=new b(f,j,i);this.radius=g;this.size=g;this.springStrength=0.1;this.targetPos=new b(f,j,i);this.velocity=new b(0,0,0);this.update=function(l){var u=this.targetPos.x-this.curPos.x;var k=u*this.springStrength;this.velocity.x+=k;this.velocity.x*=1-l;this.curPos.x+=this.velocity.x;var s=this.targetPos.y-this.curPos.y;var t=s*this.springStrength;this.velocity.y+=t;this.velocity.y*=1-l;this.curPos.y+=this.velocity.y;var q=this.originalPos.x-this.curPos.x;var n=this.originalPos.y-this.curPos.y;var o=(q*q)+(n*n);var m=Math.sqrt(o);this.targetPos.z=m/100+1;var p=this.targetPos.z-this.curPos.z;var r=p*this.springStrength;this.velocity.z+=r;this.velocity.z*=1-l;this.curPos.z+=this.velocity.z;this.radius=this.size*this.curPos.z;if(this.radius<1){this.radius=1}};this.draw=function(k){k.fillStyle=this.colour;k.beginPath();k.arc(this.curPos.x,this.curPos.y,this.radius,0,Math.PI*2,true);k.fill()}}function a(){this.mousePos=new b(0,0);this.points=new Array();this.newPoint=function(g,i,h){var f=new c(g,i,h);this.points.push(f);return f};this.update=function(m){var l=this.points.length;for(var k=0;k<l;k++){var g=this.points[k];if(g==null){continue}var j=this.mousePos.x-g.curPos.x;var h=this.mousePos.y-g.curPos.y;var f=(j*j)+(h*h);var n=Math.sqrt(f);if(n<150){g.targetPos.x=(this.mousePos.x<g.curPos.x)?g.curPos.x-j:g.curPos.x-j;g.targetPos.y=(this.mousePos.y<g.curPos.y)?g.curPos.y-h:g.curPos.y-h}else{g.targetPos.x=g.originalPos.x;g.targetPos.y=g.originalPos.y}g.update(m)}};this.draw=function(g){var j=this.points.length;for(var h=0;h<j;h++){var f=this.points[h];if(f==null){continue}f.draw(g)}}}function d(f,j,g,o,p){var i="http://jadimmock.com/services/datauriservice/";this.src=f;this.img=new Image();this.maxLength=j||200;this.xOrigin=g;this.yOrigin=o;this.ballSize=p&&p.ballSize||3;this.spacing=p&&p.spacing||14;this.variance=p&&p.variance||0;this.img.onload=l(this);h(this.img,this.src);this.updateOptions=function(q){this.ballSize=q&&q.ballSize||this.ballSize;this.spacing=q&&q.spacing||this.spacing;this.variance=q&&q.variance||this.variance;l(this).call(this)};function l(u){var s=u.img,r=u.maxLength,q=u.ballSize,t=u.variance,v=u.spacing;return function(){var E=new Array(),L=m(s,r,v),C=n(s,L),z=(u.xOrigin||(v*L.width))-(v*L.width/2),D=(u.yOrigin||(v*L.width))-(v*L.height/2),A,K,I,w,F,H,J;for(var B=0,G=C.length;B<G;B+=4){w=C[B];F=C[B+1];H=C[B+2];J=C[B+3];if(w<250||F<250||H<250){A="rgba("+w+","+F+","+H+", "+J+")";K=z+((B/4)%L.width+0.5)*v;I=D+(Math.floor(B/(4*L.width))+0.5)*v;varSize=q+(Math.random()*t/100*q);E.push(new c(K,I,0,varSize,A))}}u.points=E}}function h(q,r){if(k(r)){q.src=r}else{jQuery.getJSON(i+"?url="+r+"&jsoncallback=?",function(s){q.width=s.width;q.height=s.height;q.src=s.data})}}function k(v){var u=location.protocol,t=location.host,q=location.port,r=new RegExp(u+"//"+t+q),s=!(new RegExp("^http[s]?:")).test(v);return s||r.test(v)}function n(r,t){var s=document.createElement("canvas"),q=s.getContext("2d");if(!t.width||!t.height){return[]}s.width=t.width;s.height=t.height;q.drawImage(r,0,0,t.width,t.height);return q.getImageData(0,0,t.width,t.height).data}function m(s,r,u){var q=Math.floor(r/u),t=q/Math.max(s.width,s.height);return{width:Math.floor(s.width*t),height:Math.floor(s.height*t)}}}d.prototype=new a();e.fn.bouncyBalls=function(p){var g,i=p&&p.friction||0.2,k=[],l,h;e(window).bind("mousemove",f);m();n();return this.each(function(){if(this.tagName.toLowerCase()==="img"){var v=e(this).offset(),s=e(this).width(),q=e(this).height(),u=v.left+(s/2),r=v.top+(q/2);if(s>70&&q>70){try{k.push(new d(this.src,Math.max(q,s),u,r));e(this).css("visibility","hidden")}catch(t){}}}});function f(s){for(var r=0,q=k.length;r<q;r++){k[r].mousePos.set(s.pageX,s.pageY)}}function n(){o();j(i);setTimeout(function(){n()},30)}function o(){var r=g[0];if(r.getContext){var s=r.getContext("2d");s.clearRect(0,0,h,l);for(var t=0,q=k.length;t<q;t++){k[t].draw(s)}}}function j(){for(var r=0,q=k.length;r<q;r++){k[r].update(i)}}function m(){g=e(document.createElement("canvas")).css({position:"absolute",top:0}).attr({height:e(document.body).height(),width:e(document.body).width()});if(p&&p.zIndex){g.css("z-index",p.zIndex)}e(document.body).append(g);h=e(g).width();l=e(g).height()}}})(jQuery);